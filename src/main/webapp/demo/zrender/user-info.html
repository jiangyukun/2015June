<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>ZRender</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ZRender">
    <meta name="author" content="kener.linfeng@gmail.com">
    <script src="doc/asset/js/esl/esl.js"></script>

    <!--<link href="doc/asset/css/zrenderHome.css" rel="stylesheet">-->
    <style>
        * {
            padding: 0;
            margin: 0;
        }

        #face {
            /*border: 1px solid #aaa;*/
            border-bottom: 1px solid #aaa;
            width: 100%;
            height: 350px;
        }
    </style>
</head>

<body>
<div id='face'></div>

<script src="doc/asset/js/jquery.js"></script>
<script>
    +function () {
        'use strict';

        require.config({
            packages: [
                {
                    name: 'zrender',
                    location: 'src',
                    main: 'zrender'
                }
            ]
        });

        var zr, LineShape, CircleShape, DropletShape, RectangleShape, CellularShape, DoubleArcAroundShape;
        var width, height;
        var CIRCLE_RAD = 2 * Math.PI;
        var clickFlag = true;
        var selfColor = '#5CB3C2', friendColor = '#D28954', friendMainColor = '#49B5FF';
        require([
            'zrender',
            'zrender/shape/Line',
            'zrender/shape/Circle',
            'zrender/shape/Rectangle',
            'zrender/shape/Droplet',
            'zrender/shape/Cellular',
            'zrender/shape/DoubleArcAround'
        ], function (zrender) {
            LineShape = require('zrender/shape/Line');
            CircleShape = require('zrender/shape/Circle');
            DropletShape = require('zrender/shape/Droplet');
            RectangleShape = require('zrender/shape/Rectangle');
            CellularShape = require('zrender/shape/Cellular');
            DoubleArcAroundShape = require('zrender/shape/DoubleArcAround');
            zr = zrender.init(document.getElementById('face'));
            width = Math.ceil(zr.getWidth());
            height = Math.ceil(zr.getHeight());
            renderCanvas(zrender, {name: 'self', count: 12, data: []}, false, true);
        });

        var i, count, lines, friends, selfRadius = 25, lineLength = 80, lineLengthStart = 30, friendToShowRadius = 30;
        var friendRadius, angleRad, centerX, centerY;
        var selfNum = 0;

        function renderCanvas(zrender, data, selfClickable, friendClickable) {
            var num;
            if (friendClickable) {
                num = selfNum;
            } else {
                num = 0;
            }
            lineLengthStart = 30;
            count = data.count;
            friendRadius = Math.sin(CIRCLE_RAD / count / 3) * lineLength; // 朋友的半径（最小的圆）
            angleRad = CIRCLE_RAD / count;
            centerX = friendRadius + lineLength;
            centerY = 2 * friendRadius + lineLength;
            lines = [];
            friends = [];
            var selfCircle = new CircleShape({
                zlevel: 3,
                style: {
                    x: centerX,
                    y: centerY,
                    r: selfRadius,
                    brushType: 'both',
                    color: '#D4D4D4',
                    strokeColor: selfColor,
                    lineWidth: 5,
                    text: data.name,
                    textPosition: 'inside',
                    textFont: 'normal 14px 微软雅黑',
                    textAlign: 'center'
                },
                clickable: selfClickable,
                onclick: function () {
                    if (!clickFlag) return;
                    selfCircle.style.r = friendToShowRadius;
                    selfCircle.zlevel = 4;
                    zr.modShape(friendToShowCircle);
                    zr.refresh();
                    zr.animate(selfCircle.id)
                            .when(1000, {
                                position: [lineLength + friendRadius + 55, 0]
                            })
                            .done(function () {
                                zr.delShape(selfCircle);
                                for (i = 0; i < count; i++) {
                                    zr.delShape(lines[i]);
                                    zr.delShape(friends[i]);
                                }
                                zr.delShape(friendInfoArea);
//                                zr.delShape(droplet);
                                zr.delShape(friendToShowCircle);
                                renderCanvas(zrender, {name: 'self', count: 10, data: []}, false, true);
                            })
                            .start();
                    clickFlag = true;
                }
            });

            for (i = 0; i < count; i++) {
                lines[i] = new LineShape({
                    zlevel: 0,
                    rotation: [0, centerX, centerY],
                    style: {
                        xStart: centerX,
                        yStart: centerY,
                        xEnd: getX(i),
                        yEnd: getY(i),
                        strokeColor: friendColor,
                        lineWidth: 1
                    },
                    hoverable: false
                });

                friends[i] = new CircleShape({
                    rotation: [0, centerX, centerY],
                    zlevel: 1,
                    style: {
                        x: getX(i),
                        y: getY(i),
                        r: getRadius(),
                        brushType: 'both',
                        color: friendColor,
                        lineWidth: 0/*,
                         text: i + 1,
                         textPosition: 'inside',
                         textColor: '#000'*/
                    },
                    hoverable: false
                });
            }

            var cellular = new CellularShape({
                style: {
                    x: getX(0, lineLength + friendRadius),
                    y: getY(0, lineLength + friendRadius),
                    startAngle: CIRCLE_RAD / 24,
                    endAngle: CIRCLE_RAD * 21 / 24,
                    colorStyle: friendMainColor,
                    lineWidth: 1,
                    count: 5
                }
            });

            var friendCircleX = getX(0, lineLength * 2 + friendRadius);
            var friendCircleY = getY(0, lineLength * 2 + friendRadius);

            var friendToShowCircle = new CircleShape({
                zlevel: 3,
                style: {
                    x: friendCircleX,
                    y: friendCircleY,
                    r: friendToShowRadius,
                    brushType: 'both',
                    color: 'rgba(255, 69, 0, 1)',
                    text: getNum(),
                    textPosition: 'inside',
                    textColor: '#000'
                },
                hoverable: false,
                clickable: friendClickable,
                onclick: function () {
                    friendToShowCircle.style.r = selfRadius;
                    zr.modShape(friendToShowCircle);
                    zr.refresh();
                    zr.animate(friendToShowCircle.id)
                            .when(1000, {
                                position: [-55 - lineLength - friendRadius, 0]
                            })
                            .done(function () {
                                zr.delShape(selfCircle);
                                for (i = 0; i < count; i++) {
                                    zr.delShape(lines[i]);
                                    zr.delShape(friends[i]);
                                }
                                zr.delShape(friendInfoArea);
//                                zr.delShape(droplet);
                                zr.delShape(friendToShowCircle);
                                renderCanvas(zrender, {name: getNum(), count: 15, data: []}, true, false);
                            })
                            .start();
                }
            });

            var doubleArcAround = new DoubleArcAroundShape({
                style: {
                    x: friendCircleX,
                    y: friendCircleY,
                    r: friendToShowRadius * 1.3,
                    colorStyle: friendMainColor
                }
            });

            var friendInfoArea = new RectangleShape({
                style: {
                    x: 2 * centerX,
                    y: centerY,
                    width: 100,
                    height: 100,
                    radius: 5,
                    color: '#fff',
                    text: '音乐小子\n阅读人数 109\n转发人数 46',
                    textColor: '#000',
                    textPosition: 'inside'
                },
                hoverable: false
            });

            zr.addShape(selfCircle);
            for (i = 0; i < count; i++) {
                zr.addShape(lines[i]);
                zr.addShape(friends[i]);
            }
            zr.addShape(cellular);
            zr.addShape(doubleArcAround);

            zr.render(function () {
                var id = setInterval(function () {
                    if (lineLengthStart == lineLength) {
                        clearInterval(id);
//                        zr.addShape(droplet);
                        zr.addShape(friendToShowCircle);
                        zr.addShape(friendInfoArea);
                        return;
                    }
                    lineLengthStart++;
                    for (i = 0; i < count; i++) {
                        var line = lines[i];
                        line.style.xEnd = getX(i);
                        line.style.yEnd = getY(i);
                        zr.modShape(line.id, line);

                        var circle = friends[i];
                        circle.style.x = getX(i);
                        circle.style.y = getY(i);
                        circle.style.r = getRadius();
                        zr.modShape(circle.id, circle);
                    }
                    zr.refresh();
                }, 20);
            });

            function getX(index, length) {
                return centerX + (length || lineLengthStart) * Math.cos(getAngle(index))
            }

            function getY(index, length) {
                return centerY - (length || lineLengthStart) * Math.sin(getAngle(index))
            }

            function getRadius() {
                return lineLengthStart * friendRadius / lineLength;
            }

            function getNum() {
                return -num % count + 1
            }

            function getAngle(index) {
                return (index || num) * angleRad + CIRCLE_RAD / 24;
            }

            function rotateAngele() {
                return num * angleRad;
            }

            function rotate() {
//                zr.delShape(droplet);
                zr.delShape(friendToShowCircle);
                zr.delShape(friendInfoArea);
                num--;
                if (friendClickable) {
                    selfNum = num;
                }
                for (i = 0; i < count; i++) {
                    friends[i].style.color = friendColor;
                    zr.modShape(friends[i]);
                    zr.refresh();
                    (function (i) {
                        zr.animate(lines[i].id)
                                .when(1000, {
                                    rotation: [rotateAngele(), centerX, centerY]
                                })
                                .done(function () {
                                    if (i == 0) {
//                                        zr.addShape(droplet);
                                        friendToShowCircle.style.text = getNum();
                                        friends[getNum() - 1].style.color = friendMainColor;
                                        zr.modShape(friends[getNum() - 1]);
                                        zr.addShape(friendToShowCircle);
                                        zr.addShape(friendInfoArea);
                                    }
                                })
                                .start();
                        zr.animate(friends[i].id)
                                .when(1000, {
                                    rotation: [rotateAngele(), centerX, centerY]
                                })
                                .start();
                    })(i);
                }
            }

            $('#face').off().on('touchmove', function () {
                clickFlag = false;
                return false;
            }).on('touchend', function () {
                if (!clickFlag) {
                    rotate();
                }
                clickFlag = true;
            });
        }

        // end
    }();
</script>
</body>
</html>
