<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>ZRender</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ZRender">
    <meta name="author" content="kener.linfeng@gmail.com">
    <script src="doc/asset/js/esl/esl.js"></script>

    <!--<link href="doc/asset/css/zrenderHome.css" rel="stylesheet">-->
    <style>
        * {
            padding: 0;
            margin: 0;
        }

        #face {
            border: 1px solid #aaa;
            width: 350px;
            height: 350px;
            background-color: rgb(35, 45, 55);
        }
    </style>
</head>

<body>
<div id='face'></div>
<button id="btn">CLICK</button>

<script src="doc/asset/js/jquery.js"></script>
<script>
    +function () {
        require.config({
            packages: [
                {
                    name: 'zrender',
                    location: 'src',
                    main: 'zrender'
                }
            ]
        });

        var zr, LineShape, CircleShape, DropletShape, RectangleSharp;
        var width, height;
        var CIRCLE_RAD = 2 * Math.PI;
        require([
            'zrender',
            'zrender/shape/Line',
            'zrender/shape/Circle',
            'zrender/shape/Rectangle',
            'zrender/shape/Droplet'
        ], function (zrender) {
            LineShape = require('zrender/shape/Line');
            CircleShape = require('zrender/shape/Circle');
            DropletShape = require('zrender/shape/Droplet');
            RectangleSharp = require('zrender/shape/Rectangle');
            zr = zrender.init(document.getElementById('face'));
            width = Math.ceil(zr.getWidth());
            height = Math.ceil(zr.getHeight());
            renderCanvas(zrender, {name: 'self', count: 10, data: []});
        });

        function renderCanvas(zrender, data) {
            var i, count = data.count, selfRadius = 30, lineLength = 80, lineLengthStart = 30;
            var friendRadius = Math.sin(CIRCLE_RAD / count / 3) * lineLength; // 朋友的半径（最小的圆）
            var angleRad = CIRCLE_RAD / count;
            var centerX = friendRadius + lineLength, centerY = 2 * friendRadius + lineLength;

            var lines = [], friends = [];
            var selfCircle = new CircleShape({
                zlevel: 3,
                style: {
                    x: centerX,
                    y: centerY,
                    r: selfRadius,
                    brushType: 'both',
                    color: 'rgba(255, 69, 0, 1)',
                    text: data.name,
                    textPosition: 'inside',
                    textFont: 'normal 14px 微软雅黑',
                    textAlign: 'center'
                }
            });

            for (i = 0; i < count; i++) {
                lines[i] = new LineShape({
                    zlevel: 0,
                    rotation: [0, centerX, centerY],
                    style: {
                        xStart: centerX,
                        yStart: centerY,
                        xEnd: getX(i),
                        yEnd: getY(i),
                        strokeColor: 'rgba(255, 255, 255, 1)',
                        lineWidth: 1
                    },
                    hoverable: false
                });

                friends[i] = new CircleShape({
                    rotation: [0, getX(i), getY(i)],
                    zlevel: 1,
                    style: {
                        x: getX(i),
                        y: getY(i),
                        r: getRadius(),
                        brushType: 'both',
                        color: 'rgba(153, 255, 255, 1)',
                        lineWidth: 0
                    },
                    hoverable: false
                });
            }
            var xStart = centerX + lineLength + friendRadius;
            var yStart = centerY;
            var droplet = new DropletShape({
                zlevel: 2,
                style: {
                    x: xStart,
                    y: yStart + 55,
                    a: 26,
                    b: 60,
                    brushType: 'both',
                    color: '#fff',
                    strokeColor: '#000',
                    lineWidth: 1
                },
                rotation: [CIRCLE_RAD / 4, xStart, yStart],
                hoverable: false
            });

            var friendToShowCircle = new CircleShape({
                zlevel: 3,
                style: {
                    x: xStart + 55,
                    y: yStart,
                    r: 20,
                    brushType: 'both',
                    color: 'rgba(255, 69, 0, 1)'
                },
                hoverable: false,
                clickable: true,
                onclick: function () {
                    friendToShowCircle.style.r = selfRadius;
                    zr.modShape(friendToShowCircle);
                    zr.refresh();
                    zr.animate(friendToShowCircle.id)
                            .when(1000, {
                                position: [-55 - lineLength - friendRadius, 0]
                            })
                            .done(function () {
                                zr.delShape(selfCircle);
                                for (i = 0; i < count; i++) {
                                    zr.delShape(lines[i]);
                                    zr.delShape(friends[i]);
                                }
                                zr.delShape(friendInfoArea);
                                zr.delShape(droplet);
                                zr.delShape(friendToShowCircle);

                                renderCanvas(zrender, {name: 'friend', count: 10, data: []});
                            })
                            .start();
                }
            });

            var friendInfoArea = new RectangleSharp({
                style: {
                    x: 2 * centerX,
                    y: 1.5 * centerY,
                    width: 100,
                    height: 100,
                    radius: 5,
                    color: 'rgb(35, 45, 55)',
                    text: 'XXX\n阅读总数50人\n被转发数20个',
                    textPosition: 'inside'
                },
                hoverable: false
            });

            zr.addShape(selfCircle);
            for (i = 0; i < count; i++) {
                zr.addShape(lines[i]);
                zr.addShape(friends[i]);
            }
            zr.addShape(friendInfoArea);

            zr.render(function () {
                var id = setInterval(function () {
                    if (lineLengthStart == lineLength) {
                        clearInterval(id);
                        zr.addShape(droplet);
                        zr.addShape(friendToShowCircle);
                        return;
                    }
                    lineLengthStart++;
                    for (i = 0; i < count; i++) {
                        var line = lines[i];
                        line.style.xEnd = getX(i);
                        line.style.yEnd = getY(i);
                        zr.modShape(line.id, line);

                        var circle = friends[i];
                        circle.style.x = getX(i);
                        circle.style.y = getY(i);
                        circle.style.r = getRadius();
                        zr.modShape(circle.id, circle);
                    }
                    zr.refresh();
                }, 20);
            });
            var num = 0;

            $('#btn').click(function () {
                rotate();
            });

            function getX(index) {
                return centerX + lineLengthStart * Math.cos(angleRad * index)
            }

            function getY(index) {
                return centerY + lineLengthStart * Math.sin(angleRad * index)
            }

            function getRadius() {
                return lineLengthStart * friendRadius / lineLength;
            }

            function rotate() {
                zr.delShape(droplet);
                zr.delShape(friendToShowCircle);
                num--;
                for (i = 0; i < count; i++) {
                    zr.animate(lines[i].id)
                            .when(1000, {
                                rotation: [num * angleRad, centerX, centerY]
                            })
                            .done(function () {
                                if (i == count) {
                                    zr.addShape(droplet);
                                    zr.addShape(friendToShowCircle);
                                }
                            })
                            .start();
                    zr.animate(friends[i].id)
                            .when(1000, {
                                rotation: [num * angleRad, centerX, centerY]
                            })
                            .start();
                }
            }
        }

        // end
    }();
</script>
</body>
</html>
